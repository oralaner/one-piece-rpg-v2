generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

// =========================================================
// üåç ENUMS (NOUVEAU SYST√àME CARTOGRAPHIE)
// =========================================================

enum Role {
  JOUEUR
  ADMIN
  MODERATEUR

  @@schema("public")
}

enum Ocean {
  EAST_BLUE
  WEST_BLUE
  NORTH_BLUE
  SOUTH_BLUE
  GRAND_LINE
  NEW_WORLD

  @@schema("public")
}

enum IslandType {
  VILLE       // Zone safe, commerce
  SAUVAGE     // Zone combat, exploration
  DONJON      // Boss
  QG_MARINE   // Danger
  EVENT       // Temporaire

  @@schema("public")
}

enum Facility {
  PORT        // R√©paration, Upgrade
  SHOP        // Achat items
  MARCHE      // HDV Joueurs
  ARENE       // PvP
  CASINO      // Jeux
  TAVERNE     // Qu√™tes / Recrutement
  FORGE       // Craft

  @@schema("public")
}

// =========================================================
// üó∫Ô∏è MODELES CARTOGRAPHIE & √âCONOMIE LOCALE
// =========================================================

model destinations {
  id            Int          @id @default(autoincrement())
  nom           String       @unique
  description   String?
  image_url     String?

  // --- COORDONN√âES & TYPE ---
  pos_x         Int          @default(0)
  pos_y         Int          @default(0)
  ocean         Ocean        @default(EAST_BLUE)
  type          IslandType   @default(SAUVAGE)

  // --- GAMEPLAY ---
  niveau_requis Int          @default(1)
  facilities    Facility[]   // Liste des infrastructures (Array PostgreSQL)
  
  // Loot table pour les √Æles sauvages
  loots_possibles Json       @default("[]") 
  
  // Stats d'exploration (optionnel pour le mode idle sur l'√Æle)
  difficulte    Int          @default(10)
  xp_gain       Int          @default(10)

  // --- CONTR√îLE DE TERRITOIRE (PHASE 5) ---
  alliance_id   String?      @db.Uuid
  taxe_percent  Int          @default(0) 
  alliance      equipages?   @relation(fields: [alliance_id], references: [id])

  // --- RELATIONS ---
  joueurs          joueurs[]       // Joueurs pr√©sents sur l'√Æle
  boutique_objets  boutique_ile[]  // Objets vendus ici

  biome            String?   @default("NORMAL") // Ex: "DESERT", "HIVER", "TROPICAL", "VOLCANIQUE"

  @@schema("public")
}
// --- Mod√®le METEO_REF ---
model meteo_ref {
  id                String   @id @default(uuid())
  nom               String   @unique
  emoji             String
  description       String
  
  coeff_xp          Float    @default(1.0)
  coeff_berrys      Float    @default(1.0)
  coeff_duree       Float    @default(1.0)
  coeff_loot_chance Float    @default(1.0)
  coeff_energie     Float    @default(1.0)

  type_zone         String   @default("GLOBAL")
  biomes_interdits  String[] @default([])
  poids_aleatoire   Int      @default(10)

  // üëá AJOUTE CETTE LIGNE POUR FIXER L'ERREUR üëá
  joueurs_en_trajet joueurs[]

  @@schema("public")
}

model boutique_ile {
  id             Int          @id @default(autoincrement())
  destination_id Int
  objet_id       Int
  
  prix           Int          // Prix sp√©cifique √† cette √Æle
  stock          Int?         // Null = Infini
  
  destination    destinations @relation(fields: [destination_id], references: [id], onDelete: Cascade)
  objet          objets       @relation(fields: [objet_id], references: [id], onDelete: Cascade)

  @@unique([destination_id, objet_id])
  @@schema("public")
}

// =========================================================
// üë§ MODELES JOUEURS & PROGRESSION
// =========================================================

model joueurs {
  id                  String      @id @db.Uuid
  pseudo              String?
  avatar_url          String?
  role                Role        @default(JOUEUR)
  
  // --- STATS ---
  niveau              Int?        @default(1)
  xp                  Int?        @default(0)
  berrys              Int?        @default(100)
  faction             String?     
  
  force               Int?        @default(10)
  defense             Int?        @default(5)
  vitalite            Int?        @default(1)
  sagesse             Int?        @default(1)
  intelligence        Int?        @default(1)
  agilite             Int?        @default(1)
  chance              Int?        @default(1)
  points_carac        Int?        @default(5)
  
  pv_actuel           Int?        @default(105)
  pv_max              Int?        @default(100)
  pv_max_base         Int?        @default(100)
  last_pv_update      DateTime?
  
  energie_actuelle    Int         @default(10)
  last_energie_update DateTime    @default(now())

  // --- COMBATS ---
  victoires           Int?        @default(0)
  defaites            Int?        @default(0)
  victoires_pve       Int?        @default(0)
  defaites_pve        Int?        @default(0)
  victoires_pvp       Int?        @default(0)
  defaites_pvp        Int?        @default(0)
  elo_pvp             Int?        @default(0)
  combats_journaliers Int?        @default(0)
  dernier_reset_combats DateTime? @default(now()) @db.Timestamptz(6)
  
  // --- SPECIFICITES ONE PIECE ---
  fruit_demon         String?
  haki_observation    Boolean?    @default(false)
  haki_armement       Boolean?    @default(false)
  haki_rois           Boolean?    @default(false)
  prime               BigInt?     @default(0)
  titre_actuel        String?

  // --- NAVIGATION (PHASE 2) ---
  statut_voyage       String?     @default("A_QUAI") // "A_QUAI", "EN_MER"
  trajet_depart_id    Int?        // ID √Æle d√©part
  trajet_arrivee_id   Int?        // ID √Æle arriv√©e
  trajet_fin          DateTime?   @db.Timestamptz(6) // Timestamp arriv√©e
  // NAVIGATION & R√âCIT
  trajet_meteo_id     String?   // M√©t√©o fix√©e au d√©part du voyage
  trajet_summary      Json?     // { "events": ["Un banc de thons crois√©", "√âpave fouill√©e"], "xp": 150, "items": [...] }
  trajet_meteo        meteo_ref? @relation(fields: [trajet_meteo_id], references: [id])
  
  // Localisation actuelle (Si A_QUAI)
  localisation_id     Int?        @default(1) // Correspond √† l'ID dans destinations
  // Ancienne relation gard√©e pour compatibilit√© (renomm√©e pour clart√©, pointe vers destinations)
  expedition_dest_id  Int?        
  iles_visitees       Int[]       @default([]) // Liste des IDs des √Æles explor√©es

  // --- NAVIRE ---
  niveau_navire       Int?        @default(1)
  nom_navire          String?     @default("Radeau de Fortune")

  // --- GESTION DES ACTIVIT√âS ---
  activite_actuelle   String?   // ID de l'activit√© (ex: "PECHE")
  activite_debut      DateTime? // Date de lancement
  activite_fin        DateTime? // Date de fin pr√©vue
  
  // Stockage JSON pour les cooldowns : { "PECHE": "2023-12-01T14:00:00Z", "MINAGE": ... }
  cooldowns           Json      @default("{}")
  
  // --- EQUIPAGE / SOCIAL ---
  equipage_id         String?     @db.Uuid
  part_xp_equipage    Int?        @default(10)
  equipage_demande_id String?     @db.Uuid
  xp_donnee_equipage  BigInt?     @default(0)
  
  // --- ACTIVIT√âS ---
  nb_expeditions_reussies Int?    @default(0)
  expedition_fin      DateTime?   @db.Timestamptz(6) // Ancien syst√®me (√† migrer plus tard)
  derniere_activite   DateTime?   @default(now()) @db.Timestamptz(6)
  derniere_fouille    DateTime?   @default(dbgenerated("(now() - '01:00:00'::interval)")) @db.Timestamptz(6)
  
  nb_crafts           Int?        @default(0)
  nb_coffres_ouverts  Int?        @default(0)
  nb_potions_bues     Int?        @default(0)
  nb_activites        Int?        @default(0)
  
  // --- ECONOMIE ---
  berrys_depenses_shop BigInt?    @default(0)
  berrys_mises_casino  BigInt?    @default(0)
  a_tout_perdu_casino  Boolean?   @default(false)
  casino_streak        Int?       @default(0)
  
  // --- TIMESTAMPS JEUX ---
  last_play_des       DateTime?   @db.Timestamptz(6)
  last_play_pfc       DateTime?   @db.Timestamptz(6)
  last_play_quitte    DateTime?   @db.Timestamptz(6)

  // --- AVENTURE ---
  chapitre_actuel     Int         @default(1)
  etape_actuelle      Int         @default(1)
  is_bot              Boolean?    @default(false)

  // --- EQUIPEMENT (IDs) ---
  equip_arme_id       Int?
  equip_tete_id       Int?
  equip_corps_id      Int?
  equip_bottes_id     Int?
  equip_bague_id      Int?
  equip_collier_id    Int?
  equip_navire_id     Int?
  deck_combat         Int[]       @default([])

  // --- RELATIONS ---
  equipage            equipages?  @relation(fields: [equipage_id], references: [id])
  localisation        destinations? @relation(fields: [localisation_id], references: [id], onDelete: NoAction, onUpdate: NoAction)  
  equip_arme          inventaire? @relation("joueurs_equip_arme_idToinventaire", fields: [equip_arme_id], references: [id], onUpdate: NoAction)
  equip_tete          inventaire? @relation("joueurs_equip_tete_idToinventaire", fields: [equip_tete_id], references: [id], onUpdate: NoAction)
  equip_corps         inventaire? @relation("joueurs_equip_corps_idToinventaire", fields: [equip_corps_id], references: [id], onUpdate: NoAction)
  equip_bottes        inventaire? @relation("joueurs_equip_bottes_idToinventaire", fields: [equip_bottes_id], references: [id], onUpdate: NoAction)
  equip_bague         inventaire? @relation("joueurs_equip_bague_idToinventaire", fields: [equip_bague_id], references: [id], onUpdate: NoAction)
  equip_collier       inventaire? @relation("joueurs_equip_collier_idToinventaire", fields: [equip_collier_id], references: [id], onUpdate: NoAction)
  equip_navire        inventaire? @relation("joueurs_equip_navire_idToinventaire", fields: [equip_navire_id], references: [id], onUpdate: NoAction)

  demandes_adhesion   demandes_adhesion[]
  equipages_diriges   equipages[] @relation("equipages_chef_idTojoueurs")
  inventaire          inventaire[] @relation("inventaire_joueur_idTojoueurs")
  joueur_competences  joueur_competences[]
  joueur_quetes       joueur_quetes[]
  joueur_titres       joueur_titres[]
  marche              marche[]
  messages            messages[]
  quetes_journalieres quetes_journalieres[]
  notifications       notifications[]

  @@index([equipage_id])
  @@index([niveau(sort: Desc)])
  @@index([elo_pvp(sort: Desc)])
  @@schema("public")
}

// =========================================================
// üè¥‚Äç‚ò†Ô∏è MODELES ALLIANCES (EQUIPAGES)
// =========================================================

model equipages {
  id                      String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nom                     String      @unique(map: "nom_unique")
  description             String?
  chef_id                 String?     @db.Uuid
  faction                 String
  date_creation           DateTime?   @default(now()) @db.Timestamptz(6)
  
  niveau                  Int?        @default(1)
  xp                      BigInt?     @default(0)
  berrys_banque           BigInt?     @default(0)
  
  // Syst√®me de Raid (V1)
  expedition_etat         String?     @default("AUCUNE")
  expedition_cible_id     Int?
  expedition_fin          DateTime?   @db.Timestamptz(6)
  expedition_participants String[]    @default([]) @db.Uuid
  expeditions_reussies    Int?        @default(0)

  // Relations
  banque_logs             banque_logs[]
  demandes_adhesion       demandes_adhesion[]
  chef                    joueurs?    @relation("equipages_chef_idTojoueurs", fields: [chef_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  membres                 joueurs[]
  
  // Contr√¥le de territoire (Phase 5)
  territoires_controles   destinations[]

  @@schema("public")
}

// =========================================================
// üì¶ MODELES ITEMS & INVENTAIRE
// =========================================================

model inventaire {
  id                                           Int       @id @default(autoincrement())
  joueur_id                                    String    @db.Uuid
  objet_id                                     Int
  quantite                                     Int?      @default(1)
  stats_perso                                  Json?
  est_equipe                                   Boolean   @default(false)
  
  joueur                                       joueurs   @relation("inventaire_joueur_idTojoueurs", fields: [joueur_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  objets                                       objets    @relation(fields: [objet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  // Relations inverses pour l'√©quipement
  equipped_as_arme     joueurs[] @relation("joueurs_equip_arme_idToinventaire")
  equipped_as_bague    joueurs[] @relation("joueurs_equip_bague_idToinventaire")
  equipped_as_bottes   joueurs[] @relation("joueurs_equip_bottes_idToinventaire")
  equipped_as_collier  joueurs[] @relation("joueurs_equip_collier_idToinventaire")
  equipped_as_corps    joueurs[] @relation("joueurs_equip_corps_idToinventaire")
  equipped_as_navire   joueurs[] @relation("joueurs_equip_navire_idToinventaire")
  equipped_as_tete     joueurs[] @relation("joueurs_equip_tete_idToinventaire")

  @@index([joueur_id])
  @@index([objet_id])
  @@schema("public")
}

model objets {
  id              Int       @id @default(autoincrement())
  nom             String    @unique
  rarete          String
  description     String?
  image_url       String?
  
  // Economie de base
  prix_achat      Int?      @default(0)
  prix_vente      Int?      @default(0)
  en_boutique     Boolean?  @default(false)
  
  est_unique      Boolean?  @default(false)
  est_craftable   Boolean?  @default(false)
  est_lootable    Boolean?  @default(true)
  
  categorie       String?
  type_equipement String?
  nom_set         String?
  
  stats_bonus     Json?     @default("{}")
  soin            Int?      @default(0)
  stock           Int?

  // Relations
  inventaire      inventaire[]
  marche          marche[]
  navire_couts    navire_upgrade_couts[]
  utilise_dans    recette_ingredients[]
  recettes        recettes[]
  
  // Nouveau : Pr√©sence dans les shops d'√Æles
  boutiques_iles  boutique_ile[]

  @@schema("public")
}

model marche {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendeur_id    String?   @db.Uuid
  objet_id      Int?
  quantite      Int?      @default(1)
  prix_unitaire Int
  stats_perso   Json?
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  
  objets        objets?   @relation(fields: [objet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  joueurs       joueurs?  @relation(fields: [vendeur_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_at(sort: Desc)])
  @@index([prix_unitaire])
  @@schema("public")
}

// =========================================================
// ‚öîÔ∏è MODELES COMBAT & SKILLS
// =========================================================

model combats {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  joueur_id            String?   @db.Uuid
  adversaire_id        String?   @db.Uuid
  pv_joueur_actuel     Int?
  pv_adversaire_actuel Int?
  tour_numero          Int?      @default(1)
  log_combat           Json?     @default("[]")
  est_termine          Boolean?  @default(false)
  vainqueur_id         String?   @db.Uuid
  created_at           DateTime? @default(now()) @db.Timestamptz(6)
  cooldowns            Json?     @default("{}")
  type                 String?

  @@schema("public")
}

model competences {
  id                 Int                  @id @default(autoincrement())
  nom                String               @unique
  description        String?
  type_degats        String?
  arme_requise       String?
  puissance          Int?                 @default(10)
  precision          Int?                 @default(90)
  cout_achat         Int?                 @default(100)
  image_url          String?
  exclusif_pnj       Boolean?             @default(false)
  cooldown           Int?                 @default(0)
  est_achetable      Boolean?             @default(true)
  joueur_competences joueur_competences[]

  @@schema("public")
}

model joueur_competences {
  joueur_id     String      @db.Uuid
  competence_id Int
  competences   competences @relation(fields: [competence_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  joueurs       joueurs     @relation(fields: [joueur_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([joueur_id, competence_id])
  @@unique([joueur_id, competence_id], map: "joueur_competences_unique")
  @@schema("public")
}

// =========================================================
// üìú MODELES QUETES & HISTOIRE
// =========================================================

model quetes_ref {
  id            Int             @id @default(autoincrement())
  description   String
  type_action   String
  objectif_qte  Int?            @default(1)
  gain_xp       Int?            @default(0)
  gain_berrys   Int?            @default(0)
  categorie     String?         @default("JOURNALIERE")
  joueur_quetes joueur_quetes[]

  @@schema("public")
}

model joueur_quetes {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  joueur_id        String?     @db.Uuid
  quete_ref_id     Int?
  avancement       Int?        @default(0)
  est_terminee     Boolean?    @default(false)
  est_recoltee     Boolean?    @default(false)
  date_attribution DateTime?   @default(dbgenerated("CURRENT_DATE")) @db.Date
  joueurs          joueurs?    @relation(fields: [joueur_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  quetes_ref       quetes_ref? @relation(fields: [quete_ref_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("public")
}

model quetes_journalieres {
  id            String   @id @default(uuid())
  joueur_id     String   @db.Uuid
  type          String
  description   String
  objectif      Int
  avancement    Int      @default(0)
  xp_reward     Int      @default(100)
  berrys_reward Int      @default(500)
  est_termine   Boolean  @default(false)
  est_recupere  Boolean  @default(false)
  date_creation DateTime @default(now())
  joueur        joueurs  @relation(fields: [joueur_id], references: [id], onDelete: Cascade)

  @@index([joueur_id])
  @@schema("public")
}

model histoire_chapitres {
  id                  String            @id @default(uuid())
  faction             String
  numero              Int
  titre               String
  description         String
  recompense_xp       Int               @default(0)
  recompense_berrys   Int               @default(0)
  recompense_objet_id String?
  unlock_island_id    Int?
  unlock_feature      String?
  etapes              histoire_etapes[]

  @@unique([faction, numero])
  @@schema("public")
}

model histoire_etapes {
  id          String             @id @default(uuid())
  chapitre_id String
  ordre       Int
  type        String
  description String
  target_nom  String?
  target_id   String?
  quantite    Int                @default(1)
  chapitre    histoire_chapitres @relation(fields: [chapitre_id], references: [id], onDelete: Cascade)

  @@schema("public")
}

// =========================================================
// üõ†Ô∏è DIVERS (CRAFT, TITRES, METEO, NAVIRE REF)
// =========================================================

model banque_logs {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  equipage_id   String?    @db.Uuid
  pseudo_joueur String?
  montant       Int?
  action        String?
  date_log      DateTime?  @default(now()) @db.Timestamptz(6)
  equipages     equipages? @relation(fields: [equipage_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([equipage_id])
  @@index([date_log(sort: Desc)])
  @@schema("public")
}

model demandes_adhesion {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  equipage_id   String?    @db.Uuid
  joueur_id     String?    @db.Uuid
  pseudo_joueur String?
  date_demande  DateTime?  @default(now()) @db.Timestamptz(6)
  equipages     equipages? @relation(fields: [equipage_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  joueurs       joueurs?   @relation(fields: [joueur_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([equipage_id, joueur_id], map: "unique_demande")
  @@schema("public")
}

model messages {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  joueur_id  String?   @db.Uuid
  pseudo     String
  faction    String?
  canal      String
  contenu    String
  date_envoi DateTime? @default(now()) @db.Timestamptz(6)
  joueurs    joueurs?  @relation(fields: [joueur_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("public")
}

model notifications {
  id         String   @id @default(uuid())
  joueur_id  String   @db.Uuid
  joueur     joueurs  @relation(fields: [joueur_id], references: [id], onDelete: Cascade)
  
  titre      String
  message    String
  type       String   @default("INFO")
  lu         Boolean  @default(false)
  
  created_at DateTime @default(now()) @db.Timestamptz(6)

  @@schema("public")
}

model meteo {
  region       String    @id
  climat       String?   @default("SOLEIL")
  derniere_maj DateTime? @default(now()) @db.Timestamptz(6)

  @@schema("public")
}

model navires_ref {
  niveau      Int                    @id
  nom         String
  image_url   String?
  description String?
  prix_berrys BigInt                 @default(0)
  cout_items  navire_upgrade_couts[]

  @@schema("public")
}

model navire_upgrade_couts {
  id            Int         @id @default(autoincrement())
  navire_niveau Int
  objet_id      Int
  quantite      Int
  navire        navires_ref @relation(fields: [navire_niveau], references: [niveau], onDelete: Cascade)
  objet         objets      @relation(fields: [objet_id], references: [id])

  @@schema("public")
}

model recettes {
  id                Int                   @id @default(autoincrement())
  nom               String
  objet_resultat_id Int?
  categorie         String?               @default("Autre")
  temps_craft       Int                   @default(10)
  xp_craft          Int                   @default(10)
  niveau_requis     Int                   @default(1)
  ingredients       recette_ingredients[]
  objet_resultat    objets?               @relation(fields: [objet_resultat_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("public")
}

model recette_ingredients {
  id                  Int      @id @default(autoincrement())
  recette_id          Int
  objet_ingredient_id Int
  quantite            Int
  objet               objets   @relation(fields: [objet_ingredient_id], references: [id])
  recette             recettes @relation(fields: [recette_id], references: [id], onDelete: Cascade)

  @@schema("public")
}

model titres_ref {
  id               Int             @id @default(autoincrement())
  nom              String          @unique
  description      String?
  condition_type   String?
  condition_valeur BigInt?         @default(0)
  est_secret       Boolean?        @default(false)
  joueur_titres    joueur_titres[]

  @@schema("public")
}

model joueur_titres {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  joueur_id      String?     @db.Uuid
  titre_id       Int?
  date_obtention DateTime?   @default(now()) @db.Timestamptz(6)
  joueurs        joueurs?    @relation(fields: [joueur_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  titres_ref     titres_ref? @relation(fields: [titre_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([joueur_id, titre_id])
  @@schema("public")
}