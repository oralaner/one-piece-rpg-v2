generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

// -------------------------------------------------------------
// PARTIE AUTH (Supabase) - NE PAS TOUCHER
// -------------------------------------------------------------

// -------------------------------------------------------------
// PARTIE JEU (PUBLIC)
// -------------------------------------------------------------

model banque_logs {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  equipage_id   String?    @db.Uuid
  pseudo_joueur String?
  montant       Int?
  action        String?
  date_log      DateTime?  @default(now()) @db.Timestamptz(6)
  equipages     equipages? @relation(fields: [equipage_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([equipage_id])
  @@index([date_log(sort: Desc)])
  @@schema("public")
}

model combats {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  joueur_id            String?   @db.Uuid
  adversaire_id        String?   @db.Uuid
  pv_joueur_actuel     Int?
  pv_adversaire_actuel Int?
  tour_numero          Int?      @default(1)
  log_combat           Json?     @default("[]")
  est_termine          Boolean?  @default(false)
  vainqueur_id         String?   @db.Uuid
  created_at           DateTime? @default(now()) @db.Timestamptz(6)
  cooldowns            Json?     @default("{}")
  type                 String?

  @@schema("public")
}

model competences {
  id                 Int                  @id @default(autoincrement())
  nom                String               @unique
  description        String?
  type_degats        String?
  arme_requise       String?
  puissance          Int?                 @default(10)
  precision          Int?                 @default(90)
  cout_achat         Int?                 @default(100)
  image_url          String?
  exclusif_pnj       Boolean?             @default(false)
  cooldown           Int?                 @default(0)
  est_achetable      Boolean?             @default(true)
  joueur_competences joueur_competences[]

  @@schema("public")
}

model demandes_adhesion {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  equipage_id   String?    @db.Uuid
  joueur_id     String?    @db.Uuid
  pseudo_joueur String?
  date_demande  DateTime?  @default(now()) @db.Timestamptz(6)
  equipages     equipages? @relation(fields: [equipage_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  joueurs       joueurs?   @relation(fields: [joueur_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([equipage_id, joueur_id], map: "unique_demande")
  @@schema("public")
}

model destinations {
  id              Int      @id @default(autoincrement())
  nom             String   @unique
  description     String?
  image_url       String?

  // Position
  pos_x           Int?     @default(50)
  pos_y           Int?     @default(50)
  region          String?  @default("East Blue")
  type_lieu       String?  @default("ILE")

  // Gameplay
  duree_minutes   Int      @default(5)
  niveau_requis   Int?     @default(1)
  difficulte      Int      @default(10) // ðŸ‘ˆ Ce champ manquait peut-Ãªtre

  // RÃ©compenses
  xp_gain         Int      @default(10) // ðŸ‘ˆ Celui-ci aussi
  gain_estime     Int?     @default(100) // (Equivalent de berrys_gain)

  loots_possibles Json     @default("[]") // ðŸ‘ˆ Et celui-ci

  joueurs         joueurs[]

  @@schema("public")
}

model equipages {
  id                                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nom                                String              @unique(map: "nom_unique")
  description                        String?
  chef_id                            String?             @db.Uuid
  faction                            String
  date_creation                      DateTime?           @default(now()) @db.Timestamptz(6)
  niveau                             Int?                @default(1)
  xp                                 BigInt?             @default(0)
  membres                            joueurs[]
  berrys_banque                      BigInt?             @default(0)
  expedition_etat                    String?             @default("AUCUNE")
  expedition_cible_id                Int?
  expedition_fin                     DateTime?           @db.Timestamptz(6)
  expedition_participants            String[]            @default([]) @db.Uuid
  expeditions_reussies               Int?                @default(0)
  banque_logs                        banque_logs[]
  demandes_adhesion                  demandes_adhesion[]
  joueurs_equipages_chef_idTojoueurs joueurs?            @relation("equipages_chef_idTojoueurs", fields: [chef_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("public")
}

model inventaire {
  id                                    Int     @id @default(autoincrement())
  joueur_id                             String  @db.Uuid
  objet_id                              Int
  quantite                              Int?    @default(1)
  stats_perso                           Json?
  est_equipe                            Boolean @default(false)
  joueurs_inventaire_joueur_idTojoueurs joueurs @relation("inventaire_joueur_idTojoueurs", fields: [joueur_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  objets                                objets  @relation(fields: [objet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Relations inverses nÃ©cessaires pour Prisma (ne pas renommer ici, c'est auto-gÃ©rÃ© via les noms de relations)
  joueurs_joueurs_equip_arme_idToinventaire    joueurs[] @relation("joueurs_equip_arme_idToinventaire")
  joueurs_joueurs_equip_bague_idToinventaire   joueurs[] @relation("joueurs_equip_bague_idToinventaire")
  joueurs_joueurs_equip_bottes_idToinventaire  joueurs[] @relation("joueurs_equip_bottes_idToinventaire")
  joueurs_joueurs_equip_collier_idToinventaire joueurs[] @relation("joueurs_equip_collier_idToinventaire")
  joueurs_joueurs_equip_corps_idToinventaire   joueurs[] @relation("joueurs_equip_corps_idToinventaire")
  joueurs_joueurs_equip_navire_idToinventaire  joueurs[] @relation("joueurs_equip_navire_idToinventaire")
  joueurs_joueurs_equip_tete_idToinventaire    joueurs[] @relation("joueurs_equip_tete_idToinventaire")

  @@index([joueur_id])
  @@index([objet_id])
  @@schema("public")
}

model joueur_competences {
  joueur_id     String      @db.Uuid
  competence_id Int
  competences   competences @relation(fields: [competence_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  joueurs       joueurs     @relation(fields: [joueur_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([joueur_id, competence_id])
  @@unique([joueur_id, competence_id], map: "joueur_competences_unique")
  @@schema("public")
}

model joueur_quetes {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  joueur_id        String?     @db.Uuid
  quete_ref_id     Int?
  avancement       Int?        @default(0)
  est_terminee     Boolean?    @default(false)
  est_recoltee     Boolean?    @default(false)
  date_attribution DateTime?   @default(dbgenerated("CURRENT_DATE")) @db.Date
  joueurs          joueurs?    @relation(fields: [joueur_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  quetes_ref       quetes_ref? @relation(fields: [quete_ref_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("public")
  
}

model joueur_titres {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  joueur_id      String?     @db.Uuid
  titre_id       Int?
  date_obtention DateTime?   @default(now()) @db.Timestamptz(6)
  joueurs        joueurs?    @relation(fields: [joueur_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  titres_ref     titres_ref? @relation(fields: [titre_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([joueur_id, titre_id])
  @@schema("public")
}

// -------------------------------------------------------------
// LE MODÃˆLE JOUEUR CORRIGÃ‰
// -------------------------------------------------------------

model joueurs {
  id                      String    @id @db.Uuid
  pseudo                  String?
  avatar_url              String?
  niveau                  Int?      @default(1)
  xp                      Int?      @default(0)
  berrys                  Int?      @default(100)
  faction                 String?   @default("Pirate")
  derniere_activite       DateTime? @default(now()) @db.Timestamptz(6)
  expedition_fin          DateTime? @db.Timestamptz(6)
  expedition_dest_id      Int?
  force                   Int?      @default(10)
  defense                 Int?      @default(5)
  pv_max                  Int?      @default(100)
  victoires               Int?      @default(0)
  defaites                Int?      @default(0)
  vitalite                Int?      @default(1)
  sagesse                 Int?      @default(1)
  intelligence            Int?      @default(1)
  agilite                 Int?      @default(1)
  chance                  Int?      @default(1)
  points_carac            Int?      @default(5)
  pv_actuel               Int?      @default(105)
  pv_max_base             Int?      @default(100)
  last_pv_update          DateTime? // Pour la rÃ©gÃ©nÃ©ration passive
  combats_journaliers     Int?      @default(0)
  energie_actuelle        Int       @default(10) // L'Ã©nergie actuelle du joueur (max 10)
  last_energie_update     DateTime  @default(now()) // Timestamp de la derniÃ¨re rÃ©gÃ©nÃ©ration/consommation
  dernier_reset_combats   DateTime? @default(now()) @db.Timestamptz(6)
  casino_streak           Int?      @default(0)
  derniere_fouille        DateTime? @default(dbgenerated("(now() - '01:00:00'::interval)")) @db.Timestamptz(6)
  deck_combat             Int[]     @default([])
  is_bot                  Boolean?  @default(false)
  victoires_pve           Int?      @default(0)
  defaites_pve            Int?      @default(0)
  victoires_pvp           Int?      @default(0)
  defaites_pvp            Int?      @default(0)
  elo_pvp                 Int?      @default(0)
  fruit_demon             String?
  equipage_id             String?   @db.Uuid
  part_xp_equipage        Int?      @default(10)
  equipage_demande_id     String?   @db.Uuid
  xp_donnee_equipage      BigInt?   @default(0)
  prime                   BigInt?   @default(0)
  haki_observation        Boolean?  @default(false)
  haki_armement           Boolean?  @default(false)
  haki_rois               Boolean?  @default(false)
  niveau_navire           Int?      @default(1)
  nom_navire              String?   @default("Radeau de Fortune")
  titre_actuel            String?
  nb_expeditions_reussies Int?      @default(0)
  nb_crafts               Int?      @default(0)
  nb_coffres_ouverts      Int?      @default(0)
  nb_potions_bues         Int?      @default(0)
  nb_activites            Int?      @default(0)
  berrys_depenses_shop    BigInt?   @default(0)
  berrys_mises_casino     BigInt?   @default(0)
  a_tout_perdu_casino     Boolean?  @default(false)
  equip_arme_id           Int?
  equip_tete_id           Int?
  equip_corps_id          Int?
  equip_bottes_id         Int?
  equip_bague_id          Int?
  equip_collier_id        Int?
  equip_navire_id         Int?
  last_play_des           DateTime? @db.Timestamptz(6)
  last_play_pfc           DateTime? @db.Timestamptz(6)
  last_play_quitte        DateTime? @db.Timestamptz(6)
  chapitre_actuel         Int       @default(1) 
  etape_actuelle          Int       @default(1) // On commence Ã  l'Ã©tape 1 du chapitre 1
  quetes_journalieres quetes_journalieres[]
  localisation_id         Int?      @default(1) // ID de l'Ã®le oÃ¹ se trouve le joueur

  // Relations
  demandes_adhesion                    demandes_adhesion[]
  equipage                             equipages?           @relation(fields: [equipage_id], references: [id])
  equipages_equipages_chef_idTojoueurs equipages[]          @relation("equipages_chef_idTojoueurs")
  joueur_competences                   joueur_competences[]
  joueur_quetes                        joueur_quetes[]
  joueur_titres                        joueur_titres[]
  destinations                         destinations?        @relation(fields: [expedition_dest_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  marche                               marche[]
  messages                             messages[]

  // âœ… CORRECTION ICI : NOMS COURTS ET PROPRES (correspondent Ã  ton game.service.ts)
  inventaire inventaire[] @relation("inventaire_joueur_idTojoueurs")

  equip_arme    inventaire? @relation("joueurs_equip_arme_idToinventaire", fields: [equip_arme_id], references: [id], onUpdate: NoAction)
  equip_tete    inventaire? @relation("joueurs_equip_tete_idToinventaire", fields: [equip_tete_id], references: [id], onUpdate: NoAction)
  equip_corps   inventaire? @relation("joueurs_equip_corps_idToinventaire", fields: [equip_corps_id], references: [id], onUpdate: NoAction)
  equip_bottes  inventaire? @relation("joueurs_equip_bottes_idToinventaire", fields: [equip_bottes_id], references: [id], onUpdate: NoAction)
  equip_bague   inventaire? @relation("joueurs_equip_bague_idToinventaire", fields: [equip_bague_id], references: [id], onUpdate: NoAction)
  equip_collier inventaire? @relation("joueurs_equip_collier_idToinventaire", fields: [equip_collier_id], references: [id], onUpdate: NoAction)
  equip_navire  inventaire? @relation("joueurs_equip_navire_idToinventaire", fields: [equip_navire_id], references: [id], onUpdate: NoAction)

  @@index([equipage_id])
  @@index([niveau(sort: Desc)]) // Pour le classement
  @@index([elo_pvp(sort: Desc)]) // Pour le classement PvP
  @@schema("public")
}

model marche {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendeur_id    String?   @db.Uuid
  objet_id      Int?
  quantite      Int?      @default(1)
  prix_unitaire Int
  stats_perso   Json?
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  objets        objets?   @relation(fields: [objet_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  joueurs       joueurs?  @relation(fields: [vendeur_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_at(sort: Desc)]) // Pour afficher les derniers ajouts
  @@index([prix_unitaire]) // Pour trier par prix
  @@schema("public")
}

model messages {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  joueur_id  String?   @db.Uuid
  pseudo     String
  faction    String?
  canal      String
  contenu    String
  date_envoi DateTime? @default(now()) @db.Timestamptz(6)
  joueurs    joueurs?  @relation(fields: [joueur_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("public")
}

model meteo {
  region       String    @id
  climat       String?   @default("SOLEIL")
  derniere_maj DateTime? @default(now()) @db.Timestamptz(6)

  @@schema("public")
}

model navires_ref {
  niveau       Int    @id // 1, 2, 3...
  nom          String
  image_url    String?
  description  String?
  
  // CoÃ»t en Berrys pour atteindre ce niveau
  prix_berrys  BigInt @default(0) 

  // Relations
  cout_items   navire_upgrade_couts[]

  @@schema("public")
}

model navire_upgrade_couts {
  id             Int         @id @default(autoincrement())
  navire_niveau  Int
  objet_id       Int
  quantite       Int

  // Relations
  navire         navires_ref @relation(fields: [navire_niveau], references: [niveau], onDelete: Cascade)
  objet          objets      @relation(fields: [objet_id], references: [id])

  @@schema("public")
}


model objets {
  id          Int     @id @default(autoincrement())
  nom         String  @unique
  rarete      String
  description String?
  image_url   String?

  // Prix
  prix_achat Int? @default(0)
  prix_vente Int? @default(0)

  // BoolÃ©ens
  en_boutique   Boolean? @default(false) // Correspond Ã  "est_achetable"
  est_unique    Boolean? @default(false)
  est_craftable Boolean? @default(false) // ðŸ‘ˆ AJOUTÃ‰ (manquait)
  est_lootable  Boolean? @default(true) // ðŸ‘ˆ AJOUTÃ‰ (pour filtrer les loots)

  // Types
  categorie       String? // ðŸ‘ˆ AJOUTÃ‰ (Ressource, Consommable, Coffre...)
  type_equipement String? // TETE, CORPS (uniquement si c'est un Ã©quipement)
  nom_set         String?

  // Stats & DonnÃ©es
  stats_bonus Json? @default("{}") // On va stocker Force, DÃ©fense etc. ici
  soin        Int?  @default(0) // ðŸ‘ˆ AJOUTÃ‰ (pour les potions/nourriture)

  stock Int?

  // Relations existantes (ne pas toucher)
  inventaire inventaire[]
  marche     marche[]
  recettes   recettes[]

  navire_couts    navire_upgrade_couts[]

  utilise_dans recette_ingredients[]

  @@schema("public")
}

model quetes_ref {
  id            Int             @id @default(autoincrement())
  description   String
  type_action   String
  objectif_qte  Int?            @default(1)
  gain_xp       Int?            @default(0)
  gain_berrys   Int?            @default(0)
  categorie     String?         @default("JOURNALIERE")
  joueur_quetes joueur_quetes[]

  @@schema("public")
}

model recettes {
  id                Int    @id @default(autoincrement())
  nom               String
  objet_resultat_id Int?

  // Supprimez "ingredients Json", on utilise la table de liaison maintenant !
  categorie   String? @default("Autre")
  temps_craft Int     @default(10)
  xp_craft    Int     @default(10)

  // Relations
  objet_resultat objets? @relation(fields: [objet_resultat_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // ðŸ‘‡ C'EST CETTE LIGNE QUI MANQUAIT (Lien inverse)
  ingredients recette_ingredients[]
  niveau_requis       Int      @default(1)       // Pour bloquer le craft si bas niveau

  @@schema("public")
}

model quetes_journalieres {
  id            String   @id @default(uuid())
  joueur_id     String   @db.Uuid
  joueur        joueurs  @relation(fields: [joueur_id], references: [id], onDelete: Cascade)
  
  type          String   // EX: 'COMBAT_WIN', 'CRAFT', 'EAT', 'EXPLORE'
  description   String   // EX: "Gagner 3 combats d'arÃ¨ne"
  objectif      Int      // EX: 3
  avancement    Int      @default(0)
  
  xp_reward     Int      @default(100)
  berrys_reward Int      @default(500)
  
  est_termine   Boolean  @default(false) // Barre pleine
  est_recupere  Boolean  @default(false) // RÃ©compense clickÃ©e
  
  date_creation DateTime @default(now())

  @@index([joueur_id])
  @@schema("public")
}

model recette_ingredients {
  id                  Int @id @default(autoincrement())
  recette_id          Int
  objet_ingredient_id Int
  quantite            Int

  // Relations
  // "recette" pointe vers le champ "ingredients" qu'on a ajoutÃ© dans le modÃ¨le recettes
  recette recettes @relation(fields: [recette_id], references: [id], onDelete: Cascade)

  // "objet" pointe vers le champ "utilise_dans" qu'on a ajoutÃ© dans le modÃ¨le objets
  objet objets @relation(fields: [objet_ingredient_id], references: [id])

  @@schema("public")
}

model titres_ref {
  id               Int             @id @default(autoincrement())
  nom              String          @unique
  description      String?
  condition_type   String?
  condition_valeur BigInt?         @default(0)
  est_secret       Boolean?        @default(false)
  joueur_titres    joueur_titres[]

  @@schema("public")
}

// DANS backend/prisma/schema.prisma

model meteo_ref {
  id                String  @id @default(uuid())
  nom               String  @unique
  emoji             String
  description       String
  
  // Modificateurs (1.0 = normal, 1.5 = +50%, 0.8 = -20%)
  coeff_xp          Float   @default(1.0)
  coeff_berrys      Float   @default(1.0)
  coeff_duree       Float   @default(1.0) // Pour "Vent ArriÃ¨re"
  coeff_reussite    Float   @default(1.0) // Pour "TempÃªte" et "Aqua Laguna"
  coeff_loot_chance Float   @default(1.0) // Pour "Brume"

  // (Optionnel) Relation si tu veux stocker la mÃ©tÃ©o actuelle du serveur quelque part
  // game_state game_state[] 
  
  @@schema("public")
}

// TABLE 1 : Le Chapitre Global
model histoire_chapitres {
  id            String   @id @default(uuid())
  faction       String   // 'PIRATE', 'MARINE', 'REVOLUTIONNAIRE'
  numero        Int      // 1
  titre         String   // "L'Aube de l'Aventure"
  description   String   // Texte d'intro global
  
  // RÃ©compenses de fin de chapitre
  recompense_xp      Int @default(0)
  recompense_berrys  Int @default(0)
  recompense_objet_id String? // ID de l'objet (ex: Radeau)
  
  // Ce que Ã§a dÃ©bloque
  unlock_island_id   Int?    // ID de l'Ã®le dÃ©bloquÃ©e
  unlock_feature     String? // Ex: 'CASINO', 'SHOP', 'ARENA'
  
  etapes        histoire_etapes[]

  @@unique([faction, numero])
  @@schema("public")
}

// TABLE 2 : Les Ã‰tapes du Chapitre
model histoire_etapes {
  id            String   @id @default(uuid())
  chapitre_id   String   
  chapitre      histoire_chapitres @relation(fields: [chapitre_id], references: [id], onDelete: Cascade)
  
  ordre         Int      // 1, 2, 3...
  type          String   // 'DIALOGUE', 'ACTION', 'LIVRAISON', 'COMBAT_PVE'
  
  description   String   // Le texte affichÃ© pour cette Ã©tape
  target_nom    String?  // "Makino", "Corde Solide", "Bandit"
  target_id     String?  // ID technique (item_id ou enemy_id) si besoin
  quantite      Int      @default(1)

  @@schema("public")
}
